---
title: "Butt et al: scRNAseq analysis - Final analyses"
author: "Agnes A. Steixner-Kumar"
date: "18 11 2020"
output: 
  pdf_document:
    latex_engine: xelatex 
    fig_caption: yes
    fig_height: 8
    fig_width: 13
    keep_tex: no
    number_sections: yes
    toc: yes
  html_notebook: 
    fig_caption: yes
    fig_height: 8
    fig_width: 13
    number_sections: yes
    toc: yes
    df_print: paged
  html_document: 
    fig_caption: yes
    fig_height: 8
    fig_width: 13
    number_sections: yes
    toc: yes
    toc_float: true
editor_options: 
  chunk_output_type: inline
---
# Load libraries and data
## Load libraries
```{r}
library(reshape2)
library(RColorBrewer)
library(grid)
library(Seurat) #v3.0.0
library(cowplot)
library(dplyr)
library(ggplot2)
library(scales)
```

## Load data
```{r}
ODD<-readRDS("F:/GEO_submission_Butt_et_al/Butt_et_al_hypoxia_Seurat.RDS")
```

# Analysis
## Figure 4B
### Create dataframe of ODD &/or tdTomato+ cells
```{r}
# prepare dataframe
ODD_tdTom_cluster<-data.frame(matrix(nrow = ncol(ODD), ncol = 5), row.names = colnames(ODD))
colnames(ODD_tdTom_cluster)=c("Cluster", "Group", "ODD", "tdTomato", "Expression")
# fill in metadata
ODD_tdTom_cluster$Cluster<-Idents(ODD)
ODD_tdTom_cluster$Sample<-ODD$Sample
ODD_tdTom_cluster$Group<-ODD$group
# get expression values
ODD_tdTom_cluster$ODD<-GetAssayData(ODD)["ODD",]
ODD_tdTom_cluster$tdTomato<-GetAssayData(ODD)["tdTomato",]
# recode
ODD_tdTom_cluster$Expression[ODD_tdTom_cluster$ODD==0 & ODD_tdTom_cluster$tdTomato==0]<-"none"
ODD_tdTom_cluster$Expression[ODD_tdTom_cluster$ODD>0 & ODD_tdTom_cluster$tdTomato==0]<-"ODD"
ODD_tdTom_cluster$Expression[ODD_tdTom_cluster$ODD==0 & ODD_tdTom_cluster$tdTomato>0]<-"tdTomato"
ODD_tdTom_cluster$Expression[ODD_tdTom_cluster$ODD>0 & ODD_tdTom_cluster$tdTomato>0]<-"both"
```
### Count positive cells
```{r}
# create count table
ODD_tdTom_cluster_counts<-ODD_tdTom_cluster %>%
 group_by(Cluster, Expression, Group) %>%
    count()
# order levels for display
ODD_tdTom_cluster_counts$Expression<-factor(ODD_tdTom_cluster_counts$Expression, levels=c("none", "both", "tdTomato", "ODD"))
```

### Clean up cluster lables
```{r}
cluster_labels<-as.character(unique(ODD_tdTom_cluster_counts$Cluster))
cluster_labels<-gsub('_', ' ', cluster_labels)
cluster_labels<-gsub('cells', '', cluster_labels)
cluster_labels<-gsub(' $', '', cluster_labels)
cluster_labels
```
### Plot proportions
```{r}
ggplot(ODD_tdTom_cluster_counts, aes(y=n, x=Cluster, fill=Expression)) +  
  geom_bar( stat="identity", position="fill")+
  scale_y_continuous(labels= scales::percent)+
  ylab("Construct expressing cells")+ 
  coord_cartesian(expand = FALSE)+
  scale_fill_manual(values=c("gray72", "lightgoldenrod1", "lightcoral", "darkseagreen3"))+ 
  annotate(geom = 'text',size=5, label=cluster_labels, y=0.99, x=seq(0:15), angle=90, hjust=1)+
  theme(axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank(), 
        axis.text.y=element_text(size=19), axis.title=element_text(size=20), legend.text=element_text(size=18), 
        legend.title=element_text(size=20),legend.position = "bottom")+
  theme(plot.margin=unit(c(0.3,3.6,0,0.7), "cm"))
```

## Figure 4D
### Create rough identity clusters
These cell types correspond to cell types distinguished in immunofluorescence quantifications
```{r}
ODD$rough_ident<-NA
# merge all neuronal types
ODD$rough_ident[ODD$final_identity=="Glutamatergic1"|ODD$final_identity=="Glutamatergic0"|ODD$final_identity=="Glutamatergic2"|
               ODD$final_identity=="Glutamatergic3"|ODD$final_identity=="Glutamatergic4"|ODD$final_identity=="Gabaergic"|ODD$final_identity=="Mossy_cells"]<-"Neurons"
ODD$rough_ident[ODD$final_identity=="Astrocytes"]<-"Astrocytes"
ODD$rough_ident[ODD$final_identity=="Oligodendrocytes"|ODD$final_identity=="OPC"]<-"OPC, Oligo"
ODD$rough_ident[ODD$final_identity=="Microglia"]<-"Microglia"
ODD$rough_ident[ODD$final_identity=="Endothelial"]<-"Endothelial"
```
### Create dataframe of binary Hk2 expression 
```{r}
# prepare dataframe
Hk2_cluster<-data.frame(matrix(nrow = sum(!is.na(ODD$rough_ident)), ncol = 4), row.names = colnames(ODD)[!is.na(ODD$rough_ident)])
colnames(Hk2_cluster)=c("Cluster", "Group", "Hk2", "Hif1a")
# fill in metadata
Hk2_cluster$Cluster<-ODD$rough_ident[!is.na(ODD$rough_ident)]
Hk2_cluster$Sample<-ODD$Sample[!is.na(ODD$rough_ident)]
Hk2_cluster$Group<-ODD$group[!is.na(ODD$rough_ident)]
# fill in expression data and recode
Hk2_cluster$Hk2<-GetAssayData(ODD)["Hk2",!is.na(ODD$rough_ident)]
Hk2_cluster$Hk2_yn[Hk2_cluster$Hk2>0]<-"yes"
Hk2_cluster$Hk2_yn[Hk2_cluster$Hk2==0]<-"no"
# create count table
Hk2_cluster_prop<-Hk2_cluster %>%
 group_by(Cluster, Group, Hk2_yn) %>%
    summarise(n=n()) %>%
        mutate(Percent=(n/sum(n))*100)

```
### Perform chi-square tests per cluster
```{r}
lapply(unique(Hk2_cluster_prop$Cluster), function(x) {paste0(x, ": ",
                                                      chisq.test(data.frame(c(Hk2_cluster_prop$n[Hk2_cluster_prop$Cluster==x][1],
                                                                              Hk2_cluster_prop$n[Hk2_cluster_prop$Cluster==x][2]),
                                                                            c(Hk2_cluster_prop$n[Hk2_cluster_prop$Cluster==x][3],
                                                                              Hk2_cluster_prop$n[Hk2_cluster_prop$Cluster==x][4])), 
                                                                  correct = T)$p.value)
  }
       )
```
### Perform chi-square tests for total sample
```{r}
# count positive/negative cells per group
Hk2_cluster_prop_total<-Hk2_cluster %>%
 group_by(Group, Hk2_yn) %>%
    summarise(n=n()) %>%
        mutate(Percent=(n/sum(n))*100)
# perform chi-square test
chisq.test(data.frame(c(Hk2_cluster_prop_total$n[1],
                        Hk2_cluster_prop_total$n[2]),
                      c(Hk2_cluster_prop_total$n[3],
                        Hk2_cluster_prop_total$n[4])), correct = F)$p.value
```
### Plot Hk2+ proportions per cluster
```{r}
# make factor, order levels
Hk2_cluster_prop$Cluster<-factor(Hk2_cluster_prop$Cluster, levels=c("Endothelial", 'Neurons', 'Astrocytes', "OPC, Oligo", 'Microglia'))

# plot
ggplot(data = Hk2_cluster_prop[Hk2_cluster_prop$Hk2_yn=="yes",], aes(x = Cluster, y = Percent)) +
  geom_col(aes(fill = Group, width=0.6), col='black' , show.legend = FALSE) +
  coord_flip()+ facet_wrap(~Group)+
theme(axis.ticks.y=element_blank(), axis.text.y=element_text(size=22, angle = 0), axis.text.x=element_text(size=25), axis.title.y=element_blank(), axis.title.x=element_text(size=25), legend.text=element_text(size=16), 
        legend.title=element_text(size=25))+
scale_fill_manual(values = c("#FFBDBD","#512274"))+
theme(strip.text.x = element_text(size = 30, colour = "black",margin = margin(0.5,0,0.5,0, "cm")))+
      theme(aspect.ratio = 1/1.1)+scale_y_continuous( limits = c(0,20), expand = c(0,0))+
theme(panel.spacing = unit(2, "lines"))+ylab('Percentage of Hk2 positive cells')+theme(plot.margin=unit(c(0,0.5,0,0), "cm"))
```

```{r}
ggplot(data = Hk2_cluster_prop[Hk2_cluster_prop$Hk2_yn=="yes",], aes(x = Cluster, y = Percent)) +
    geom_col(aes(fill = Group, width=0.6), col='black' , show.legend = FALSE) +
    coord_flip()+ facet_wrap(~Group)+
    theme(axis.ticks.y=element_blank(), axis.text.y=element_blank(), axis.text.x=element_text(size=32), axis.title.y=element_blank(), axis.title.x=element_text(size=25), legend.text=element_text(size=15), 
          legend.title=element_text(size=25))+
    scale_fill_manual(values = c("#FFBDBD","#512274"))+
    theme(strip.text.x = element_text(size = 30, colour = "black",margin = margin(0.5,0,0.5,0, "cm")))+
    theme(aspect.ratio = 1/0.85)+scale_y_continuous( limits = c(0,20), expand = c(0,0))+
    theme(panel.spacing = unit(2.5, "lines"))+ylab('Percentage of Hk2 positive cells')+theme(plot.margin=unit(c(0,0.61,0,0.18), "cm"))
```

```{r}
```

```{r}
identities <- levels(Idents(ODD_nodoub))
my_color_palette <- hue_pal()(length(identities))
my_color_palette
```

```{r}
my_color_palette <-c('brown2', my_color_palette[2:16])
```

```{r}
DimPlot(ODD_nodoub, reduction = 'umap', label =F, repel = T, cols = my_color_palette)+NoLegend()+NoAxes()
ggsave(paste0(out_dir, "graphs/UMAP_figure_no_label_doubletclean.jpg"), width = 13.5, height = 10, units = "cm")
```

```{r}
cellID_dimex<-colnames(ODD_nodoub)[Embeddings(ODD_nodoub[["umap"]])[,2]>(-20)]
length(cellID_dimex)
dim(ODD_nodoub)
head(cellID_dimex)
cellID_norm<-intersect(colnames(ODD_nodoub)[ODD_nodoub$group=="Normoxia"], cellID_dimex)
cellID_hyp<-intersect(colnames(ODD_nodoub)[ODD_nodoub$group=="Hypoxia"], cellID_dimex)
length(cellID_norm)
length(cellID_hyp)

```

```{r}
ODD_norm<-subset(ODD_nodoub, cells = cellID_norm)
FeaturePlot(ODD_norm, features = c("ODD"), pt.size = 0.7, order=F, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_ODD_min0.5_max2_normox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")

ODD_hyp<-subset(ODD_nodoub, cells = cellID_hyp)
FeaturePlot(ODD_hyp, features = c("ODD"), pt.size = 0.7, order=F, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_ODD_min0.5_max2_hypox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")
```

```{r}
FeaturePlot(ODD_norm, features = c("tdTomato"), pt.size = 0.7, order=F, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_tdTomato_min0.5_max2_normox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")

FeaturePlot(ODD_hyp, features = c("tdTomato"), pt.size = 0.7, order=F, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_tdTomato_min0.5_max2_hypox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")
```

```{r}
FeaturePlot(ODD_norm, features = c("Vegfa"), pt.size = 0.7, order=F, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_Vegfa_min0.5_max2_normox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")

FeaturePlot(ODD_hyp, features = c("Vegfa"), pt.size = 0.7, order=F, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_Vegfa_min0.5_max2_hypox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")

```

```{r}
FeaturePlot(ODD_norm, features = c("Hk2"), pt.size = 0.7, order=T, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_Hk2_min0.5_max2_normox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")

FeaturePlot(ODD_hyp, features = c("Hk2"), pt.size = 0.7, order=T, min.cutoff = 0.5, max.cutoff = 2, cols = (c("bisque2", "black")))+NoAxes()+ggtitle('')+
NoLegend()+theme(plot.margin=unit(c(-1,-0.5,-0,-0.5), "cm"))
ggsave(paste0(out_dir, "graphs/Featureplot_Hk2_min0.5_max2_hypox_figure_doubletclean.jpg"), width = 8, height = 6, units = "cm")

```


```{r}
Vegfa_p<-FindMarkers(ODD_nodoub, ident.1 = 'Hypoxia', ident.2 = 'Normoxia', group.by = 'group', features = 'Vegfa')
Vegfa_p
```

```{r}
Idents(ODD_nodoub)<-ODD_nodoub$group
levels(Idents(ODD_nodoub))
```

```{r}
Hk2_p_norm<-FindMarkers(ODD_nodoub, ident.1 = 'Microglia', subset.ident = 'Normoxia', group.by = 'final_identity', features = 'Hk2', logfc.threshold = 0.01)
Hk2_p_hyp<-FindMarkers(ODD_nodoub, ident.1 = 'Microglia', subset.ident = 'Hypoxia', group.by = 'final_identity', features = 'Hk2', logfc.threshold = 0.01)
Hk2_p_norm
Hk2_p_hyp
```

```{r}
ODD_nodoub
```

```{r}
#calculate number of doublets excluded
28114-25850
```

```{r}
table(ODD_nodoub$group)
```

```{r}
unique(ODD_nodoub$RNA_snn_res.0.2)
```

